pipeline {
    agent any
    stages {
        stage('Prepare build agent') {
            agent {
                docker {
                    image 'openjdk:17.0.1-jdk-slim'
                    args '-v /var/run/docker.sock:/var/run/docker.sock -v /Users/alperkurtoglu/.m2:/root/.m2 -u root:root'
                    reuseNode true
                }
            }
            stages {
                stage('[Backend] Clean') {
                    steps {
                        sh './mvnw clean'
                    }
                }
                stage('[Backend] Compile') {
                    steps {
                        sh './mvnw compile'
                    }
                }
                stage('[Backend] Package') {
                    steps {
                        sh './mvnw package -DskipTests'
                    }
                }
                stage('[Backend] Push Image') {
                    steps {
                        withCredentials([usernamePassword(credentialsId: 'nexus-credentials', passwordVariable: 'DOCKER_REGISTRY_PASS', usernameVariable: 'DOCKER_REGISTRY_USER')]) {
                            sh "./mvnw compile jib:build -Dimage=localhost:9093/repository/twitter-repository/twitter-clone:${env.BUILD_ID} -Djib.to.auth.username=$DOCKER_REGISTRY_USER -Djib.to.auth.password=$DOCKER_REGISTRY_PASS"
                        }
                    }
                }
            }
        }
    }
}
